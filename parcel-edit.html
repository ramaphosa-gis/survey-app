<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Parcel | Homeland Surveyors</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --card-bg: #0b0b0b; /* solid black like parcel-view */
      --muted: #ccc;
      --accent: #00b4d8;
      --success: #00a86b;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: url("assets/survey-bg.jpg") center/cover no-repeat fixed;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      background: rgba(0, 0, 0, 0.85);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    header h1 {
      margin: 0;
      font-size: 1.15rem;
      color: #fff;
    }

    header button {
      background: #ff3b3b;
      border: none;
      color: #fff;
      padding: .45rem .85rem;
      border-radius: 6px;
      cursor: pointer;
    }

    /* main container like parcel-view */
    main.container {
      background: #0b0b0b; /* solid dark background */
      backdrop-filter: none;
      margin-top: 2rem;
      padding: 2rem;
      border-radius: 16px;
      max-width: 980px;
      width: 92%;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    main.container, main.container p {
      font-size: 1.5rem;
      line-height: 1.3;
    }

    form { display: block; }

    label {
      display: block;
      color: var(--muted);
      font-size: 1.2rem;
      margin-top: 12px;
      font-weight: 600;
    }

    input[type="text"], input[type="date"], input[type="number"], textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.03);
      color: #fff;
      font-size: 1.2rem;
      outline: none;
    }

.owners {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 0; /* remove gap to make lines continuous */
  border: 2px solid rgba(255, 255, 255, 0.6); /* stronger outer border */
  border-radius: 8px;
  overflow: hidden; /* keeps corners neat */
}

.owner-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 40px;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-bottom: 1.2px solid rgba(255, 255, 255, 0.4); /* middle line */
  background: rgba(255, 255, 255, 0.03);
}

.owner-row:last-child {
  border-bottom: none; /* no line after last owner */
}

.owner-row input {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
  font-size: 1.15rem;
}

.owner-row button {
  background: #d9534f;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px;
  cursor: pointer;
}

    .mini-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }

    .section-title {
      color: var(--accent);
      margin-top: 14px;
      font-weight: 700;
      font-size: 1.5rem;
    }

    /* FEES TABLE STYLE */
    .fees-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border: 2px solid rgba(255, 255, 255, 0.6); /* made visible */
    }

    .fees-table th, .fees-table td {
      border: 1px solid rgba(255, 255, 255, 0.6); /* made visible */
      padding: 10px;
      text-align: left;
    }

    .fees-table th {
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.05);
    }

    .fees-table input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.03);
      color: #fff;
      font-size: 1.1rem;
    }

    /* thumbnails */
    .thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .thumb {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: #111;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumb .delete-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(255, 0, 0, 0.9);
      border: none;
      color: white;
      padding: 4px 6px;
      border-radius: 6px;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    button.save {
      background: var(--success);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.05rem;
    }

    button.cancel {
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05rem;
    }
  </style>
</head>
<body>
</h1> 
<button id="backBtn">‚Üê Back</button> 
</header> 
<main class="container" role="main"> 
  <form id="editForm" autocomplete="off"> 
    <label>Parcel Number</label> 
    <input id="parcelNumber" type="text" required /> 
    <label>Survey Date</label> 
    <input id="surveyDate" type="date" /> 
    <h3 class="section-title">Owners</h3> 
    <div id="ownersList" class="owners"></div> 
    <button type="button" id="addOwnerBtn" class="mini-btn">+ Add Owner</button> 
    <h3 class="section-title">Fees</h3> 
    <table class="fees-table"> 
      <tr> 
        <th>Fee Type</th> 
        <th>Paid</th> 
        <th>Pending</th> 
      </tr> 
      <tr> 
        <td>Survey Fees</td> 
        <td><input id="surveyPaid" type="number" step="0.01" /></td> 
        <td><input id="surveyPending" type="number" step="0.01" /></td> 
      </tr> 
      <tr> 
        <td>Board Fees</td> 
        <td><input id="boardPaid" type="number" step="0.01" /></td> 
        <td><input id="boardPending" type="number" step="0.01" /></td> 
      </tr> 
      <tr> 
        <td>Title Fees</td> 
        <td><input id="titlePaid" type="number" step="0.01" /></td> 
        <td><input id="titlePending" type="number" step="0.01" /></td> 
      </tr> 
    </table> 
    <h3 class="section-title">Existing Images</h3> 
    <div id="existingImages" class="thumbs" aria-live="polite"></div> 
    <label style="margin-top:12px">Add Images (optional)</label> 
    <input id="editParcelFiles" type="file" multiple accept="image/*,application/pdf" /> 
    <div id="editFilePreview" class="thumbs"></div> 
    <div class="actions"> 
      <button type="button" id="cancelBtn" class="cancel">Cancel</button> 
      <button type="submit" class="save">üíæ Save Changes</button> 
    </div> 
  </form> 
</main> 

<script type="module"> 
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"; 
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"; 
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"; 

const firebaseConfig = { 
  apiKey: "AIzaSyD3La6BOzBUnybZy_OhCt54UEeWjaAD0XY", 
  authDomain: "homeland-d1159.firebaseapp.com", 
  projectId: "homeland-d1159", 
  storageBucket: "homeland-d1159.firebasestorage.app", 
  messagingSenderId: "429299746991", 
  appId: "1:429299746991:web:9d4f06f0051ba693ef2c5a" 
}; 
const app = initializeApp(firebaseConfig); 
const auth = getAuth(app); 

const SUPABASE_URL = "https://alhcuhdabdlapywwskjl.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsaGN1aGRhYmRsYXB5d3dza2psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODkyMDUsImV4cCI6MjA3NjE2NTIwNX0.iOBcMvY15vuZqNQOUjjVAsYoVj2YzbA3GRdr6T6p86E"; 
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 

const ownersList = document.getElementById("ownersList"); 
const addOwnerBtn = document.getElementById("addOwnerBtn"); 
const editForm = document.getElementById("editForm"); 
const existingImages = document.getElementById("existingImages"); 
const editFilesInput = document.getElementById("editParcelFiles"); 
const editFilePreview = document.getElementById("editFilePreview"); 
const cancelBtn = document.getElementById("cancelBtn"); 
const backBtn = document.getElementById("backBtn"); 

const params = new URLSearchParams(window.location.search); 
const parcelId = params.get("id"); 
const BUCKET = "parcel-images"; 

function sanitize(name) { 
  return name.toLowerCase().replace(/\s+/g, "_").replace(/[^\w\-\.]/g, ""); 
} 

addOwnerBtn.addEventListener("click", () => { 
  const div = document.createElement("div"); 
  div.className = "owner-row"; 
  div.innerHTML = `
    <input placeholder="Name" class="ownerName" />
    <input placeholder="ID" class="ownerID" />
    <input placeholder="KRA" class="ownerKRA" />
    <button type="button" class="deleteOwnerBtn">üóë</button>`; 
  ownersList.appendChild(div); 
}); 

ownersList.addEventListener("click", e => { 
  if (e.target.classList.contains("deleteOwnerBtn")) { 
    e.target.parentElement.remove(); 
  } 
}); 

editFilesInput.addEventListener("change", () => { 
  editFilePreview.innerHTML = ""; 
  Array.from(editFilesInput.files).forEach(f => { 
    const div = document.createElement("div"); 
    div.className = "thumb"; 
    if (f.type.startsWith("image/")) { 
      const img = document.createElement("img"); 
      img.src = URL.createObjectURL(f); 
      img.onload = () => URL.revokeObjectURL(img.src); 
      div.appendChild(img); 
    } else { 
      const lbl = document.createElement("div"); 
      lbl.className = "label"; 
      lbl.textContent = f.name; 
      div.appendChild(lbl); 
    } 
    editFilePreview.appendChild(div); 
  }); 
}); 

let existingParcelData = null;

onAuthStateChanged(auth, async user => { 
  if (!user) { 
    window.location.href = "login.html"; 
    return; 
  } 
  const { data: parcel } = await supabase.from("parcels").select("*").eq("id", parcelId).single(); 
  if (!parcel) { 
    alert("Parcel not found"); 
    window.location.href = "parcel.html"; 
    return; 
  } 
  existingParcelData = parcel;

  document.getElementById("parcelNumber").value = parcel.parcel_number || ""; 
  document.getElementById("surveyDate").value = parcel.survey_date || ""; 
  (parcel.owners || []).forEach(o => { 
    const div = document.createElement("div"); 
    div.className = "owner-row"; 
    div.innerHTML = `
      <input value="${o.name || ""}" class="ownerName" />
      <input value="${o.id || ""}" class="ownerID" />
      <input value="${o.kra || ""}" class="ownerKRA" />
      <button type="button" class="deleteOwnerBtn">üóë</button>`; 
    ownersList.appendChild(div); 
  }); 

  document.getElementById("surveyPaid").value = parcel.survey_fees?.paid ?? ""; 
  document.getElementById("surveyPending").value = parcel.survey_fees?.pending ?? ""; 
  document.getElementById("boardPaid").value = parcel.board_fees?.paid ?? ""; 
  document.getElementById("boardPending").value = parcel.board_fees?.pending ?? ""; 
  document.getElementById("titlePaid").value = parcel.title_fees?.paid ?? ""; 
  document.getElementById("titlePending").value = parcel.title_fees?.pending ?? ""; 

  existingImages.innerHTML = ""; 
  (parcel.imagesurl || []).forEach(url => { 
    const div = document.createElement("div"); 
    div.className = "thumb"; 
    div.innerHTML = `<a href="${url}" target="_blank" rel="noopener"><img src="${url}" alt="file" /></a>`; 
    existingImages.appendChild(div); 
  }); 
}); 

editForm.addEventListener("submit", async e => { 
  e.preventDefault(); 
  const owners = Array.from(document.querySelectorAll(".owner-row")).map(row => ({ 
    name: row.querySelector(".ownerName").value, 
    id: row.querySelector(".ownerID").value, 
    kra: row.querySelector(".ownerKRA").value 
  })); 

  const updated = { 
    parcel_number: document.getElementById("parcelNumber").value.trim(), 
    survey_date: document.getElementById("surveyDate").value || null, 
    owners, 
    survey_fees: { 
      paid: document.getElementById("surveyPaid").value || 0, 
      pending: document.getElementById("surveyPending").value || 0 
    }, 
    board_fees: { 
      paid: document.getElementById("boardPaid").value || 0, 
      pending: document.getElementById("boardPending").value || 0 
    }, 
    title_fees: { 
      paid: document.getElementById("titlePaid").value || 0, 
      pending: document.getElementById("titlePending").value || 0 
    } 
  }; 

  // Merge existing images + new uploads
  const files = Array.from(editFilesInput.files); 
  const newImageUrls = existingParcelData.imagesurl ? [...existingParcelData.imagesurl] : []; 
  const newImagesMeta = existingParcelData.images ? [...existingParcelData.images] : []; 

  for (const file of files) { 
    const fileName = `${parcelId}/${Date.now()}-${sanitize(file.name)}`; 
    const { error: uploadError } = await supabase.storage.from(BUCKET).upload(fileName, file, { contentType: file.type, upsert: true }); 
    if (uploadError) { 
      console.error("Upload failed:", uploadError.message); 
      continue; 
    } 
    const { publicUrl } = supabase.storage.from(BUCKET).getPublicUrl(fileName); 
    newImageUrls.push(publicUrl); 
    newImagesMeta.push({ name: file.name, type: file.type, url: publicUrl, uploaded_at: new Date().toISOString() }); 
  } 

  updated.imagesurl = newImageUrls; 
  updated.images = newImagesMeta; 

  const { error } = await supabase.from("parcels").update(updated).eq("id", parcelId); 
  if (error) { 
    console.error("Update failed:", error.message); 
    alert("‚ùå Failed to update parcel!"); 
    return; 
  } 
  alert("‚úÖ Parcel updated successfully!"); 
  window.location.href = `parcel-view.html?id=${parcelId}`; 
}); 

cancelBtn.addEventListener("click", () => { window.location.href = `parcel-view.html?id=${parcelId}`; }); 
backBtn.addEventListener("click", () => { window.location.href = `parcel-view.html?id=${parcelId}`; }); 
</script>

</body>
</html>
