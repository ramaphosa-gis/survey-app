<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Parcel Details | Homeland Surveyors</title>
	<link rel="stylesheet" href="style.css" />
	<style>
		/* --- Layout & Background --- */
		body {
			margin: 0;
			font-family: "Segoe UI", sans-serif;
			background: url("assets/survey-bg.jpg") center/cover no-repeat fixed;
			backdrop-filter: brightness(60%);
			color: #fff;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		header {
			width: 100%;
			background: rgba(0, 0, 0, 0.8);
			padding: 1rem 2rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
			position: sticky;
			top: 0;
			z-index: 10;
		}

		header h1 {
			font-size: 1.3rem;
			letter-spacing: 0.5px;
			margin: 0;
		}

		header button {
			background: #ff3b3b;
			color: white;
			border: none;
			border-radius: 6px;
			padding: 0.5rem 1rem;
			cursor: pointer;
			font-weight: 500;
			transition: 0.2s;
		}

		header button:hover {
			background: #d83232;
		}

		main.parcel-view {
			background: #0b0b0b;
			backdrop-filter: none;
			margin-top: 2rem;
			padding: 2rem;
			border-radius: 16px;
			max-width: 980px;
			width: 92%;
			box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
			border: 1px solid rgba(255, 255, 255, 0.08);
		}

		main h2 {
			text-align: center;
			margin-bottom: 1rem;
			color: #00b4d8;
			font-weight: 600;
		}

		#parcelDetails p {
			font-size: 1.5rem;
			margin: 0.6rem 0;
			color: #ddd;
		}

		#parcelDetails h3 {
			color: #00b4d8;
			margin-top: 1.4rem;
			font-size: 1.4rem;
		}

		/* --- Updated Table Styling --- */
		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 0.5rem;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 8px;
			overflow: hidden;
			border: 1.5px solid rgba(255, 255, 255, 0.2);
			/* Outer border visible */
		}

		th,
		td {
			border: 1.2px solid rgba(255, 255, 255, 0.3);
			/* Clearer internal lines */
			padding: 0.8rem 1rem;
			text-align: left;
			font-size: 1.2rem;
		}

		th {
			background: rgba(0, 180, 216, 0.2);
			color: #fff;
			font-weight: 600;
		}

		td {
			background: rgba(255, 255, 255, 0.05);
			color: #ddd;
		}

		table tr:hover td {
			background: rgba(0, 180, 216, 0.1);
		}

		/* --- Other unchanged styles --- */
		ul {
			list-style: none;
			padding: 0;
			margin: 0.5rem 0 0;
		}

		.images-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			gap: 12px;
			margin-top: 12px;
		}

		.img-tile {
			width: 100%;
			height: 120px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 10px;
			overflow: hidden;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.img-tile img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.file-tile {
			padding: 8px;
			text-align: center;
			font-size: 13px;
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 100%;
		}

		.controls {
			display: flex;
			gap: 8px;
			justify-content: flex-end;
			margin-top: 12px;
		}

		.btn {
			background: rgba(255, 255, 255, 0.06);
			border: none;
			color: #fff;
			padding: 8px 12px;
			border-radius: 8px;
			cursor: pointer;
		}

		.btn.primary {
			background: #00a86b;
		}

		@media (max-width: 640px) {
			.images-grid {
				grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
			}

			.img-tile {
				height: 90px;
			}
		}

    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #00b4d8;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
	</style>
</head>

<body>
	<header>
		<h1>Homeland Surveyors</h1>
		<div>
			<button id="backBtn">← Back</button>
			<button id="editBtn" class="btn">✏️ Edit</button>
		</div>
	</header>

	<main class="parcel-view" aria-live="polite">
		<h2>Parcel Details</h2>
		<div id="parcelDetails">
      <div class="spinner-container"><div class="spinner"></div></div>
    </div>
	</main>

	<script type="module">
		import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

		const SUPABASE_URL = "https://alhcuhdabdlapywwskjl.supabase.co";
		const SUPABASE_ANON_KEY =
			"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsaGN1aGRhYmRsYXB5d3dza2psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODkyMDUsImV4cCI6MjA3NjE2NTIwNX0.iOBcMvY15vuZqNQOUjjVAsYoVj2YzbA3GRdr6T6p86E";

		const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
		const params = new URLSearchParams(window.location.search);
		const id = params.get("id");

		function isImageUrl(url) {
			return /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?.*)?$/i.test(url);
		}

		async function loadParcel() {
			const container = document.getElementById("parcelDetails");
			container.innerHTML = `<div class="spinner-container"><div class="spinner"></div></div>`;

			const { data, error } = await supabase
				.from("parcels")
				.select("*")
				.eq("id", id)
				.single();

			if (error || !data) {
				container.innerHTML = "<p>Parcel not found.</p>";
				return;
			}

			const imgs = data.imagesurl || [];

			const ownersHtml = (data.owners || [])
				.map(
					(o, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${o.name}</td>
            <td>${o.id}</td>
            <td>${o.kra}</td>
          </tr>`
				)
				.join("");

			let imagesHtml = "";
			if (imgs && imgs.length > 0) {
				imagesHtml =
					`<div class="images-grid">` +
					imgs
						.map((url) => {
							if (isImageUrl(url)) {
								return `
              <div class="img-tile">
                <a href="${url}" target="_blank">
                  <img src="${url}" alt="parcel file" />
                </a>
              </div>`;
							} else {
								const name = url.split("/").pop().split("?")[0];
								return `
              <div class="img-tile">
                <a href="${url}" target="_blank" class="file-tile">
                  ${name}
                </a>
              </div>`;
							}
						})
						.join("") +
					`</div>`;
			} else {
				imagesHtml = `<p style="color:#ccc">No files uploaded for this parcel.</p>`;
			}

			// fees table
			const feesHtml = `
        <table>
          <thead>
            <tr><th>Fee Type</th><th>Paid</th><th>Pending</th></tr>
          </thead>
          <tbody>
            <tr><td>Survey Fees</td><td>${escapeHtml(
				(data.survey_fees?.paid ?? 0).toString()
			)}</td><td>${escapeHtml(
				(data.survey_fees?.pending ?? 0).toString()
			)}</td></tr>
            <tr><td>Board Fees</td><td>${escapeHtml(
				(data.board_fees?.paid ?? 0).toString()
			)}</td><td>${escapeHtml(
				(data.board_fees?.pending ?? 0).toString()
			)}</td></tr>
            <tr><td>Title Deed Fees</td><td>${escapeHtml(
				(data.title_fees?.paid ?? 0).toString()
			)}</td><td>${escapeHtml(
				(data.title_fees?.pending ?? 0).toString()
			)}</td></tr>
          </tbody>
        </table>
      `;

			container.innerHTML = `
        <p><strong>Parcel Number:</strong> ${escapeHtml(data.parcel_number)}</p>
        <p><strong>Survey Date:</strong> ${escapeHtml(
				data.survey_date || "N/A"
			)}</p>
        
        <h3>Owners</h3>
        <table>
          <thead>
            <tr><th>#</th><th>Name</th><th>ID Number</th><th>KRA PIN</th></tr>
          </thead>
          <tbody>${ownersHtml || "<tr><td colspan='4'>No owners listed</td></tr>"
				}</tbody>
        </table>

        <h3>Files & Images</h3>
        ${imagesHtml}

        <h3>Fees</h3>
        ${feesHtml}
      `;

			document.getElementById("editBtn").addEventListener("click", () => {
				window.location.href = `parcel-edit.html?id=${data.id}`;
			});
		}

		function escapeHtml(str) {
			if (!str) return "";
			return String(str)
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#039;");
		}

		document.getElementById("backBtn").addEventListener("click", () => {
			if (document.referrer && document.referrer !== window.location.href) {
				window.history.back();
			} else {
				window.location.href = "parcel.html";
			}
		});

		loadParcel();
	</script>
</body>

</html>